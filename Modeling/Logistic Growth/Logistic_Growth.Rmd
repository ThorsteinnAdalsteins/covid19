---
title: "Herma framtíðar aldursgögn"
author: "Brynjólfur Gauti Jónsson"
date: "3/17/2020"
output:
  html_document:
    code_folding: hide
    theme: flatly
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = F, message = F, fig.asp = 0.621, out.width = "100%", fig.width = 8)
```



```{r}
library(tidyverse); library(cowplot); library(kableExtra); library(scales); library(gganimate)
library(lubridate); library(emmeans); library(broom); library(propagate)
theme_set(theme_classic(base_size = 12) + 
            background_grid(color.major = "grey90", 
                            color.minor = "grey95", 
                            minor = "xy", major = "xy") +
            theme(legend.position = "none"))
select <- dplyr::select
```

```{r}
d <- read_csv("smit.csv") %>% 
  filter(tegund == "Samtals",
         fjoldi > 0)
```

# Logistic growth

```{r}
hist_preds <- list()
for (i in seq(10, 18)) {
  model_d <- d %>% slice(seq_len(i))
  ice.g <- nls(fjoldi ~ SSlogis(dagar, phi1, phi2, phi3), data = model_d)
  hist_preds[[i]] <- predict(ice.g)
}

make_hist_preds <- function(index) {
  model_d <- d %>% slice(seq_len(index))
  ice.g <- nls(fjoldi ~ SSlogis(dagar, phi1, phi2, phi3), data = model_d)
  preds_obj <- predictNLS(ice.g, newdata = tibble(dagar = seq(0, 60)), interval = "prediction")
  preds <- preds_obj$summary %>% 
    as_tibble %>%
    select(pred = "Sim.Mean", upper = "Sim.97.5%") %>% 
    mutate(dagar = row_number() - 1, 
           last_day = ymd("2020-02-29") + index)
}

map_df(seq(10, 18))
```



```{r}
ice.g <- nls(fjoldi ~ SSlogis(dagar, phi1, phi2, phi3), data = d)
```

```{r}
if (!file.exists("preds.csv")) {
  preds_obj <- predictNLS(ice.g, newdata = tibble(dagar = seq(0, 60)), interval = "prediction")
  
  preds <- preds_obj$summary %>% 
    as_tibble %>%
    select(pred = "Sim.Mean", upper = "Sim.97.5%") %>% 
    mutate(dagar = row_number() - 1)
  write_csv(preds, "preds.csv")
  
} else {
  preds <- read_csv("preds.csv")
}
```

```{r}
preds  %>% 
  mutate(dags = min(d$dags) + dagar) %>% 
  ggplot(aes(dags, pred)) +
  geom_line() +
  geom_line(aes(y = upper), lty = 2) +
  labs(title = "Forspáð þróun og 95% PI") +
  theme(axis.title = element_blank()) +
  ggsave("Myndir/Heild/syktir.png", width = 8, height = 0.621 * 8, scale = 2)
```

# Herma

Gagnataflan að neðan er sett saman með

`p_tilfelli`: aldursdreifing smita skv [covid.is](covid.is). Bæti við einu tilfelli í alla aldurshópa til að leyfa smit í 80+

`p_spitali` og `p_alvarlegt`: [tafla 1 héðan]

```{r}
aldur <- tibble(aldur = c("[0 - 9]",
                          "[10 - 19]", 
                          "[20 - 29]",
                          "[30 - 39]",
                          "[40 - 49]",
                          "[50 - 59]", 
                          "[60 - 69]", 
                          "[70 - 79]",
                          "80+"),
                tilfelli = c(2, 12, 28, 34, 61, 45, 38, 5, 0) + 1) %>% 
  mutate(p_tilfelli = tilfelli / sum(tilfelli),
         p_spitali = c(0.001, 0.003, 0.012, 0.032, 0.049, 0.102, 0.166, 0.243, 0.273),
         p_alvarlegt = c(0.05, 0.05, 0.05, 0.05, 0.063, 0.122, 0.274, 0.432, 0.709))
aldur %>% 
  kable %>% 
  kable_styling()
```


Skref í hermun:

1) Met logistic growth líkan og fæ forspá úr því, mean og 97.5% predictive upper limit
2) Nota fyrirliggjandi aldursdreifingu smita og forspár til að herma framtíðartilfelli með multinomial (bætti einu tilviki við alla aldurshópa til að fá ekki 0 í 80+)
3) Nota [table 1 héðan](https://www.imperial.ac.uk/media/imperial-college/medicine/sph/ide/gida-fellowships/Imperial-College-COVID19-NPI-modelling-16-03-2020.pdf?fbclid=IwAR2jkFkpT583W2vFnbYNzHE539Gj6dzKvAVVfT0Tkyg8TEilNuUkW7V0yzk) til að herma sjúkahúslegur út frá skiptingu tilfella
4) Nota sömu töflu til að spá fyrir um bráð tilfelli meðal ofangreinda sjúkrahúsinnlagna
5) Sæki miðgildi og valið quantile úr öllum ofangreindum hermunum og skila í gagnatöflu.


```{r}
make_pred <- function(estimate, upper, aldur, n = 1000, q = 0.95) {
  cases_est <- rmultinom(n = n, size = estimate, prob = aldur$p_tilfelli)
  cases_upper <- rmultinom(n = n, size = upper, prob = aldur$p_tilfelli)
  
  rows <- nrow(cases_est)
  cols <- ncol(cases_est)
  
  hospital_est <- matrix(0, nrow = rows, ncol = cols)
  hospital_upper <- matrix(0, nrow = rows, ncol = cols)
  serious_est <- matrix(0, nrow = rows, ncol = cols)
  serious_upper <- matrix(0, nrow = rows, ncol = cols)
  
  for (i in seq_len(cols)) {
    hospital_est[, i] <- rbinom(rows, size = cases_est[, i], prob = aldur$p_spitali)
    serious_est[, i] <- rbinom(rows, size = hospital_est[, i], prob = aldur$p_alvarlegt)
    
    hospital_upper[, i] <- rbinom(rows, size = cases_upper[, i], prob = aldur$p_spitali)
    serious_upper[, i] <- rbinom(rows, size = hospital_upper[, i], prob = aldur$p_alvarlegt)
  }
  
  
  median_cases <- apply(cases_est, 1, median)
  upper_cases <- apply(cases_upper, 1, quantile, probs = q)
  
  median_hospital <- apply(hospital_est, 1, median)
  upper_hospital <- apply(hospital_upper, 1, quantile, prob = q)
  
  median_serious <- apply(serious_est, 1, median)
  upper_serious <- apply(serious_upper, 1, quantile, prob = q)
  
  tibble(aldur = aldur$aldur,
         median_cases = median_cases,
         upper_cases = upper_cases,
         median_hospital = median_hospital,
         upper_hospital = upper_hospital,
         median_serious = median_serious,
         upper_serious = upper_serious) %>% 
    list
}
```

```{r}
if (!file.exists("simulations.csv")) {
  simulations <- preds %>% 
    rowwise %>% 
    mutate(simulation = make_pred(pred, upper, aldur, n = 10000)) %>% 
    unnest(simulation) %>% 
    mutate(dags = dagar + min(d$dags)) %>% 
    pivot_longer(c(starts_with("median_"), starts_with("upper_"))) %>% 
    separate(name, into = c("type", "variable"), sep = "_") %>% 
    select(dags, aldur, variable, type, value) %>% 
    pivot_wider(names_from = "type", values_from = "value")
  
  write_csv(simulations, "simulations.csv")
} else {
  simulations <- read_csv("simulations.csv")
}
```


## Aldursskipting

```{r, fig.asp = 1}
simulations %>% 
  filter(variable == "cases") %>% 
  ggplot(aes(dags, median)) +
  geom_line() +
  geom_line(aes(y = upper), lty = 2) +
  facet_wrap("aldur", scales = "free") +
  scale_y_continuous(breaks = pretty_breaks(5)) +
  labs(title = "Forspáð tilfelli eftir aldri",
       subtitle = "Reiknað út frá 97.5% PI á fjölda og hermt með fjölkostadreifingu",
       y = "Tilfelli") +
  theme(axis.title = element_blank())  +
  ggsave("Myndir/Eftir aldri/syktir.png", width = 8, height = 8, scale = 2)
```

## Sjúkrahúslegur

### Aldursskipt

```{r, fig.asp = 1}
simulations %>% 
  filter(variable == "hospital") %>% 
  ggplot(aes(dags, median)) +
  geom_line() +
  geom_line(aes(y = upper), lty = 2) +
  facet_wrap("aldur", scales = "free") +
  scale_y_continuous(breaks = pretty_breaks(5)) +
  labs(title = "Forspáðar sjúkrahúslegur eftir aldri",
       subtitle = "Reiknað út frá 97.5% PI á fjölda og hermt með fjölkostadreifingu") +
  theme(axis.title = element_blank())  +
  ggsave("Myndir/Eftir aldri/sjukrahus_innlagnir.png", width = 8, height = 8, scale = 2)
```


### Samtals

```{r, fig.asp = 0.621}
simulations %>% 
  filter(variable == "hospital") %>% 
  group_by(dags) %>% 
  summarise(median = sum(median),
            upper = sum(upper)) %>% 
  ggplot(aes(dags, median)) +
  geom_smooth() +
  geom_line() +
  geom_smooth(aes(y = upper), lty = 2) +
  geom_line(aes(y = upper), lty = 2) +
  scale_y_continuous(breaks = pretty_breaks(5)) +
  labs(title = "Forspáðar sjúkrahúslegur í heildina",
       subtitle = "Reiknað út frá 97.5% PI á fjölda og hermt með fjölkostadreifingu",
       y = "Tilfelli") +
  theme(axis.title = element_blank())  +
  ggsave("Myndir/Heild/sjukrahus_innlagnir.png", width = 8, height = 8, scale = 2)
```


## Alvarleg tilfelli á sjúkrahúsi

### Aldursskipt

```{r, fig.asp = 1}
simulations %>% 
  filter(variable == "serious") %>% 
  ggplot(aes(dags, median)) +
  geom_line() +
  geom_line(aes(y = upper), lty = 2) +
  facet_wrap("aldur", scales = "free") +
  scale_y_continuous(breaks = pretty_breaks(5)) +
  labs(title = "Forspáð alvarleg tilfelli á sjúkrahúsi eftir aldri",
       subtitle = "Reiknað út frá 97.5% PI á fjölda og hermt með fjölkostadreifingu",
       y = "Tilfelli") +
  theme(axis.title = element_blank())  +
  ggsave("Myndir/Eftir aldri/sjukrahus_alvarleg_tilfelli.png", width = 8, height = 8, scale = 2)
```

### Samtals

```{r, fig.asp = 0.621}
simulations %>% 
  filter(variable == "serious") %>% 
  group_by(dags) %>% 
  summarise(median = sum(median),
            upper = sum(upper)) %>% 
  ggplot(aes(dags, median)) +
  geom_smooth() +
  geom_line() +
  geom_smooth(aes(y = upper), lty = 2) +
  geom_line(aes(y = upper), lty = 2) +
  scale_y_continuous(breaks = pretty_breaks(5)) +
  labs(title = "Forspáð alvarleg tilfelli á sjúkrahúsi í heildina",
       subtitle = "Reiknað út frá 97.5% PI á fjölda og hermt með fjölkostadreifingu",
       y = "Tilfelli") +
  theme(axis.title = element_blank())  +
  ggsave("Myndir/Heild/sjukrahus_alvarleg_tilfelli.png", width = 8, height = 8, scale = 2)
```

# Hækkum tíðni meðal eldri

```{r}
aldur2 <- tibble(aldur = c("[0 - 9]",
                           "[10 - 19]", 
                           "[20 - 29]",
                           "[30 - 39]",
                           "[40 - 49]",
                           "[50 - 59]", 
                           "[60 - 69]", 
                           "[70 - 79]",
                           "80+"),
                 tilfelli = c(2, 12, 28, 34, 61, 50, 45, 9, 4) + 1) %>% 
  mutate(p_tilfelli = tilfelli / sum(tilfelli),
         p_spitali = c(0.001, 0.003, 0.012, 0.032, 0.049, 0.102, 0.166, 0.243, 0.273),
         p_alvarlegt = c(0.05, 0.05, 0.05, 0.05, 0.063, 0.122, 0.274, 0.432, 0.709))
```

```{r}
aldur %>% 
  mutate(type = "Alvöru") %>% 
  bind_rows(
    aldur2 %>% 
      mutate(type = "Ímyndað")
  ) %>% 
  select(aldur, p_tilfelli, type) %>% 
  mutate(p_tilfelli = percent(p_tilfelli)) %>% 
  pivot_wider(names_from = type, values_from = p_tilfelli) %>% 
  kable %>% 
  kable_styling
```


```{r}
if (!file.exists("simulations.csv")) {
  simulations2 <- preds %>% 
    rowwise %>% 
    mutate(simulation = make_pred(pred, upper,  aldur2, n = 1000)) %>% 
    unnest(simulation) %>% 
    mutate(dags = dagar + min(d$dags)) %>% 
    pivot_longer(c(starts_with("median_"), starts_with("upper_"))) %>% 
    separate(name, into = c("type", "variable"), sep = "_") %>% 
    select(dags, aldur, variable, type, value) %>% 
    pivot_wider(names_from = "type", values_from = "value")
  
  write_csv(simulations, "simulations.csv")
} else {
  simulations <- read_csv("simulations.csv")
}
```

## Aldursskipting

```{r, fig.asp = 1}
simulations %>% 
  filter(variable == "cases") %>% 
  ggplot(aes(dags, median)) +
  geom_line() +
  geom_line(aes(y = upper), lty = 2) +
  facet_wrap("aldur", scales = "free") +
  scale_y_continuous(breaks = pretty_breaks(5)) +
  labs(title = "Forspáð tilfelli eftir aldri",
       subtitle = "Reiknað út frá 97.5% PI á fjölda og hermt með fjölkostadreifingu",
       y = "Tilfelli") +
  theme(axis.title = element_blank())  +
  ggsave("Myndir/Eftir aldri/syktir.png", width = 8, height = 8, scale = 2)
```

## Sjúkrahúslegur

### Aldursskipt

```{r, fig.asp = 1}
simulations %>% 
  filter(variable == "hospital") %>% 
  ggplot(aes(dags, median)) +
  geom_line() +
  geom_line(aes(y = upper), lty = 2) +
  facet_wrap("aldur", scales = "free") +
  scale_y_continuous(breaks = pretty_breaks(5)) +
  labs(title = "Forspáðar sjúkrahúslegur eftir aldri",
       subtitle = "Reiknað út frá 97.5% PI á fjölda og hermt með fjölkostadreifingu") +
  theme(axis.title = element_blank())  +
  ggsave("Myndir/Eftir aldri/sjukrahus_innlagnir.png", width = 8, height = 8, scale = 2)
```


### Samtals

```{r, fig.asp = 0.621}
simulations %>% 
  filter(variable == "hospital") %>% 
  group_by(dags) %>% 
  summarise(median = sum(median),
            upper = sum(upper)) %>% 
  ggplot(aes(dags, median)) +
  geom_smooth() +
  geom_line() +
  geom_smooth(aes(y = upper), lty = 2) +
  geom_line(aes(y = upper), lty = 2) +
  scale_y_continuous(breaks = pretty_breaks(5)) +
  labs(title = "Forspáðar sjúkrahúslegur í heildina",
       subtitle = "Reiknað út frá 97.5% PI á fjölda og hermt með fjölkostadreifingu",
       y = "Tilfelli") +
  theme(axis.title = element_blank())  +
  ggsave("Myndir/Heild/sjukrahus_innlagnir.png", width = 8, height = 8, scale = 2)
```


## Alvarleg tilfelli á sjúkrahúsi

### Aldursskipt

```{r, fig.asp = 1}
simulations %>% 
  filter(variable == "serious") %>% 
  ggplot(aes(dags, median)) +
  geom_line() +
  geom_line(aes(y = upper), lty = 2) +
  facet_wrap("aldur", scales = "free") +
  scale_y_continuous(breaks = pretty_breaks(5)) +
  labs(title = "Forspáð alvarleg tilfelli á sjúkrahúsi eftir aldri",
       subtitle = "Reiknað út frá 97.5% PI á fjölda og hermt með fjölkostadreifingu",
       y = "Tilfelli") +
  theme(axis.title = element_blank())  +
  ggsave("Myndir/Eftir aldri/sjukrahus_alvarleg_tilfelli.png", width = 8, height = 8, scale = 2)
```

### Samtals

```{r, fig.asp = 0.621}
simulations %>% 
  filter(variable == "serious") %>% 
  group_by(dags) %>% 
  summarise(median = sum(median),
            upper = sum(upper)) %>% 
  ggplot(aes(dags, median)) +
  geom_smooth() +
  geom_line() +
  geom_smooth(aes(y = upper), lty = 2) +
  geom_line(aes(y = upper), lty = 2) +
  scale_y_continuous(breaks = pretty_breaks(5)) +
  labs(title = "Forspáð alvarleg tilfelli á sjúkrahúsi í heildina",
       subtitle = "Reiknað út frá 97.5% PI á fjölda og hermt með fjölkostadreifingu",
       y = "Tilfelli") +
  theme(axis.title = element_blank())  +
  ggsave("Myndir/Heild/sjukrahus_alvarleg_tilfelli.png", width = 8, height = 8, scale = 2)
```

# Sögulegar forspár

```{r}
read_csv("historical_preds.csv") %>% 
  # filter(last_day >= ymd("2020-03-15")) %>% 
  ggplot(aes(dagar, pred)) +
  geom_line() +
  geom_line(aes(y = upper), lty = 2) +
  labs(title = "Forspáður smitafjöldi",
       subtitle = "Miðað við gögn TIL OG MEÐ: {previous_state}") +
  transition_states(last_day, state_length = 0.12, transition_length =0.1) +
  ease_aes() +
  view_follow()
anim_save("forspa_gif.gif")
```

```{r}
read_csv("historical_preds.csv") %>% 
  # filter(last_day >= ymd("2020-03-15")) %>% 
  ggplot(aes(dagar, pred)) +
  geom_line() +
  geom_line(aes(y = upper), lty = 2) +
  labs(title = "Forspáður smitafjöldi",
       subtitle = "Miðað við gögn TIL OG MEÐ: {previous_state}") +
  transition_states(last_day, state_length = 0.2, transition_length =0.1) +
  ease_aes()
anim_save("forspa_gif_fastir_asar.gif")
```

```{r}
read_csv("historical_preds.csv") %>% 
  # filter(last_day >= ymd("2020-03-15")) %>% 
  ggplot(aes(dagar, pred)) +
  geom_line() +
  geom_line(aes(y = upper), lty = 2) +
  labs(title = "Forspáður smitafjöldi",
       subtitle = "Miðað við gögn TIL OG MEÐ: {previous_state}") +
  transition_states(last_day, state_length = 0.2, transition_length =0.1) +
  coord_cartesian(ylim = c(0, 2000)) +
  ease_aes()
anim_save("forspa_gif_fastir_asar_2.gif")
```